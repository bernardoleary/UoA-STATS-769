
# STATS 769 Lab 02

## The data

The data are trips on electric scooters and bikes in Austin, Texas.
The data came in the form of eleven CSV files, one per month (form
April 2018 to February 2019).  Each file contains 5000 trips.

The following code reads the CSV files into R and combines them to
create a single data frame.

```{r}
years <- rep(2018:2019, c(9, 2))
months <- c(4:12, 1:2)
filenames <- paste0("trips-", years, "-", months, ".csv")
files <- file.path("/course/Labs/Lab02", filenames)
trips <- do.call(rbind, lapply(files, read.csv))
```

A test set was generated by selecting 1000 rows at random from each month.
The following code does this by generating 11 sets of 
1000 numbers between 1 and 5000 and adds 0, 5000, up to 50000 to the sets.
The training set consists of the remaining 44000 rows of data.

```{r}
testIndex <- unlist(lapply(1:11, 
                            function(i) {
                                sample(1:5000, 1000) + (i - 1)*5000
                            }))
testTrips <- trips[testIndex, ]
trainTrips <- trips[-testIndex, ]
```

```{r echo=FALSE, results="hide"}
stopifnot(all(dim(testTrips) == c(11000, 14)))
stopifnot(all(dim(trainTrips) == c(44000, 14)))
stopifnot(all(table(testTrips$month) == rep(1000, 11)))
```

We will be working with the trip distance and trip duration variables.
As for the previous lab, we take only the positive values of each
variable.  The duration variable is logged to make it more symmetric
and a new variable 'modelLongTrip' is created.  The latter is 
a binary variable that indicates whether the trip distance
was longer than 1km.  We will use that variable as our response
and attempt to predict "long" trips using trip duration.

```{r}
modelTrips <- subset(trainTrips, Trip.Distance > 0 & Trip.Duration > 0)
modelLongTrip <- modelTrips$Trip.Distance > 1000
modelDuration <- log(modelTrips$Trip.Duration)
```

These transformations reduce the training set to 
`r nrow(modelTrips)` observations.

A boxplot of the trip durations for long versus short trips 
suggests that long trips generally last longer (!).

```{r}
boxplot(modelDuration ~ modelLongTrip, ylab="duration", xlab="long trip")
```

The following code breaks trip durations into bins (ignoring the
extremely short and extremely long trips) and shows the proportion
of long trips in each bin.  This shows that the proportion of long trips
generally increases as a function of trip duration.

```{r}
breaks <- 3:9
modelDurationBins <- cut(modelDuration, breaks)
modelProps <- prop.table(table(modelDurationBins, modelLongTrip), 1)
plot(breaks[-1] - diff(breaks)/2, modelProps[,2],
     main="Training Set",
     xlab="trip duration", ylab="proportion of long trips")
```

## The model

We fit a logistic model that predicts the proportion of long trips
as a function of trip duration.
We also calculate a simple proportion of long trips overall for comparison.

```{r}
overallProp <- mean(modelLongTrip)
glmFit <- glm(y ~ x, data.frame(x=modelDuration, y=modelLongTrip), 
              family="binomial")
```

The following plot shows that the model does a reasonable job 
of modelling the proportion of long trips (in the training set).

```{r echo=FALSE}
plot(breaks[-1] - diff(breaks)/2, modelProps[,2],
     main="Training Set",
     xlab="trip duration", ylab="proportion of long trips")
modelPred <- predict(glmFit, type="response")
o <- order(modelDuration)
lines(modelDuration[o], modelPred[o])
```

To evaluate the model on the test set, we define the same variables
as before.

```{r}
evalTrips <- subset(testTrips, Trip.Distance > 0 & Trip.Duration > 0)
evalLongTrip <- evalTrips$Trip.Distance > 1000
evalDuration <- log(evalTrips$Trip.Duration)
```

This reduces the test set to `r nrow(evalTrips)` observations.

The model predicts probabilities of a long trip and the following
plot shows that these again seem reasonable for the test data.

```{r}
evalPred <- predict(glmFit, data.frame(x=evalDuration), type="response")
```

```{r echo=FALSE}
evalDurationBins <- cut(evalDuration, breaks)
evalProps <- prop.table(table(evalDurationBins, evalLongTrip), 1)
plot(breaks[-1] - diff(breaks)/2, evalProps[,2],
     main="Test Set",
     xlab="trip duration", ylab="proportion of long trips")
o <- order(evalDuration)
lines(evalDuration[o], evalPred[o])
```

The following code assesses the accuracy of the model predictions
and also shows the accuracy for a simple overall proportion prediction.

```{r}
library(caret)
confusionMatrix(factor(rep(overallProp > .5, length(evalLongTrip)),
                       levels=c(FALSE, TRUE)),
                factor(evalLongTrip))
confusionMatrix(factor(evalPred > .5), factor(evalLongTrip))
```

## Working in Linux

This report was created within a directory that is visible both on my
desktop and on the
virtual machines for the course.
The virtual machines were accessed via ssh.
The following shell commands were used to create and change into the
directory.

```
mkdir Lab02
cd Lab02
```

The R Markdown file was created and edited using Emacs on my 
desktop and then processed on one
of the virtual machines using the following code.

```
Rscript -e 'rmarkdown::render("lab02-model.Rmd")'
```

The CSV data files are located on the virtual machine
within the '/course/Labs/Lab02/' directory, so the code
in this report only works when the the R Markdown file is
processed on one of the virtual machines.

## Conclusion

The data for this exercise came in a CSV format, which presented no
difficulties for importing into R.

Generating a test set was slightly complicated by requiring sub-samples
from each month, though this only required standard R data manipulation tools.

We required a log-transformation of the duration variable
to obtain unimodal, symmetric data for model fitting.  This required
excluding non-positive distances (about 8% of the data),
which means that our predictive model is only valid for trips 
that had a non-zero distance or duration.  We are unlikely to be predicting 
zero-distance trips, so this is not a large concern.

We created a new "long trips" variable, which was TRUE if the trip
distance was greater than 1km.  Simple plots suggested that the trip
duration would be a useful predictor of the probability of a long trip.

We fitted a simple logistic regression model, which 
predicted long trips with `r round(100*confusionMatrix(factor(evalPred > .5), factor(evalLongTrip))$overall["Accuracy"])`% accuracy.
