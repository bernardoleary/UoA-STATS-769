
# STATS 769 Lab 01

## The data

The data are trips on electric scooters and bikes in Austin, Texas.
The data came in the form of three CSV files, one per month (form
July to September, 2018).  Each file contains 5000 trips.

The following code reads the CSV files into R and combines them to
create a single data frame.

```{r}
filenames <- paste0("trips-2018-", 7:9, ".csv")
trips <- do.call(rbind, lapply(filenames, read.csv))
```

A test set was generated by selecting 1000 rows at random from each month.
The following code does this by generating 3 sets of 
1000 numbers between 1 and 5000 and adding 0, 5000, and 10000 to the sets.
The training set consists of the remaining 12000 rows of data.

```{r}
testIndex <- unlist(lapply(1:3, 
                            function(i) {
                                sample(1:5000, 1000) + (i - 1)*5000
                            }))
testTrips <- trips[testIndex, ]
trainTrips <- trips[-testIndex, ]
```

```{r echo=FALSE, results="hide"}
stopifnot(all(dim(testTrips) == c(3000, 7)))
stopifnot(all(dim(trainTrips) == c(12000, 7)))
stopifnot(all(table(testTrips$month) == rep(1000, 3)))
```

Exploratory plots of trip durations and trip distances show a high right-skew,
but log-durations and log-distances are reasonably unimodal and symmetric.

```{r}
modelTrips <- subset(trainTrips, duration > 0 & distance > 0)
trainDuration <- log(modelTrips$duration)
trainDistance <- log(modelTrips$distance)
```

In order to take logs, it is necessary to remove all non-positive 
durations and/or distances.  This reduces the training set to 
`r nrow(modelTrips)` observations. 

```{r}
plot(density(trainDuration), 
     main="Distribution of Trip Durations\n(training set)")
plot(density(trainDistance),
     main="Distribution of Trip Distances\n(training set)")
```

A plot of log-duration against log-distance shows a strong, 
roughly linear trend,
though the relationship breaks down for shorter trips.

```{r}
plot(trainDuration ~ trainDistance)
```

## The model

We fit a linear model, plus calculate a simple mean for comparison.

```{r}
meanFit <- mean(trainDuration)
lmFit <- lm(y ~ x, data.frame(x=trainDistance, y=trainDuration))
```

The linear model provides a lot better fit to the training data
than a simple mean, though it under-predicts durations for longer distances.
This is a result of the higher variation of durations at short distances
"dragging" the fitted line up at the left end.


```{r}
plot(trainDuration ~ trainDistance)
abline(h=meanFit, col="blue")
abline(lmFit, col="red")
```

We prepare and transform the test set using the same subsetting and
transformations that we used for the training set.

```{r}
evalTrips <- subset(testTrips, duration > 0 & distance > 0)
testDistance <- log(evalTrips$distance)
testDuration <- log(evalTrips$duration)
```

This reduces the test set to `r nrow(evalTrips)` observations.

When we look at how the model performs on the test data, 
we see a very similar result;  a straight line is a reasonable fit,
but we are not predicting durations as well at long distances.

```{r}
plot(testDuration ~ testDistance)
abline(h=meanFit, col="blue")
abline(lmFit, col="red")
```

The RMSE measure shows clear improvement of a linear model prediction
over a simple mean prediction, though there is still a large amount
of unexplained variability.

```{r echo=FALSE}
RMSE <- function(m, o) {
    sqrt(mean((m - o)^2))
}
```
```{r}
RMSE(meanFit, testDuration)
RMSE(predict(lmFit, data.frame(x=testDistance)), testDuration)
```

## Conclusion

The data for this exercise came in a CSV format, which presented no
difficulties for importing into R.

Generating a test set was slightly complicated by requiring sub-samples
from each month, though this only required standard R data manipulation tools.

We required a log-transformation of both distance and duration variables
to obtain unimodal, symmetric data for model fitting.  This required
excluding non-positive distances and durations (about 8% of the data),
which means that our predictive model is only valid for trips 
that had a non-zero distance or duration.  We are unlikely to be predicting 
zero-distance or zero-duration trips, so this is not a large concern.

We fitted a simple linear regression model, which provided some predictive
power, though there are clear opportunities for a more flexible model
(or a more robust model) to perform better.
